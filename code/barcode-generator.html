<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºç‰ˆæ¡å½¢ç ç”Ÿæˆå™¨</title>
    <script src="./js/JsBarcode.all.min.js"></script>
    <script src="./js/jszip.min.js"></script>
    <script src="./js/FileSaver.min.js"></script>
    <style>
        :root {
            --primary: #2196F3;
            --secondary: #4CAF50;
            --error: #f44336;
            --success: #4CAF50;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-section {
            margin: 0 1rem 2rem;
            position: relative;
        }

        .input-header {
            display: flex;
            justify-content: flex-end;
            margin: 0 1rem 0.5rem;
        }

        textarea {
            width: calc(100% - 2rem - 2px);
            /* åŒ…å«è¾¹æ¡†å®½åº¦ */
            height: 150px;
            padding: 1rem;
            margin: 0 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: Consolas, monospace;
            font-size: 14px;
            line-height: 1.6;
            box-sizing: border-box;
            display: block;
        }

        .input-header label {
            font-size: 1.1rem;
            font-weight: 500;
            color: #333;
            letter-spacing: 0.5px;
            margin: auto;
            /* ä¿æŒå·¦å¯¹é½ */
            padding-left: 4px;
            position: relative;
        }

        .input-header label::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100px;
            height: 2px;
            background: var(--primary);
        }

        /* å¤åˆ¶æŒ‰é’® */
        .copy-input-btn {
            padding: 4px 12px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            right: 0;
            max-width: 120px;
            /* å›ºå®šæœ€å°å®½åº¦ */
        }

        .copy-input-btn:hover {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin: 1rem;
        }

        select,
        button {
            width: 100%;
            padding: 0.8rem;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        select {
            border: 1px solid #ddd;
        }

        button {
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .primary-btn {
            background: var(--primary);
            color: white;
        }

        .secondary-btn {
            background: var(--secondary);
            color: white;
        }

        /* é¢„è§ˆåŒºåŸŸ */
        .preview-grid {
            width: calc(100% - 2rem - 2px);
            /* ä¸è¾“å…¥æ¡†å®Œå…¨ä¸€è‡´ */
            margin: 0 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #fafafa;
            box-sizing: border-box;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            margin: 1rem;
            padding: 0.8rem;
            border-radius: 4px;
        }

        .error {
            background: #ffebee;
            color: var(--error);
        }

        .success {
            background: #e8f5e9;
            color: var(--success);
        }

        .loading::after {
            content: " ...";
            animation: dots 1s infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: " .";
            }

            40% {
                content: " ..";
            }

            60% {
                content: " ...";
            }

            80%,
            100% {
                content: " ";
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¦ å¢å¼ºç‰ˆæ¡å½¢ç ç”Ÿæˆå™¨</h1>
            <p>è¾“å…¥å†…å®¹ï¼ˆæ¯è¡Œä¸€ä¸ªæ¡å½¢ç ï¼‰ï¼Œé€‰æ‹©æ ¼å¼åç”Ÿæˆ</p>
        </div>

        <div class="input-section">
            <div class="input-header">
                <label>æ¡å½¢ç è¾“å…¥</label>
                <button class="copy-input-btn" onclick="copyInputContent()">ğŸ“‹ å¤åˆ¶å†…å®¹</button>
            </div>
            <textarea id="inputArea" placeholder="ç¤ºä¾‹ï¼ˆæ³¨æ„ä¸åŒæ ¼å¼çš„è¦æ±‚ï¼‰ï¼š
5901234123457  (EAN13)
123456789012    (UPC-A)
PRODUCT-CODE-39 (CODE39)
[2023]ITEM-001  (CODE128)"></textarea>

            <div class="controls-panel">
                <select id="formatSelect">
                    <option value="CODE128">CODE 128 (é€šç”¨)</option>
                    <option value="CODE39">CODE 39 (å­—æ¯æ•°å­—)</option>
                    <option value="CODE93">CODE 93</option>
                    <option value="EAN13">EAN-13 (å•†å“æ¡ç )</option>
                    <option value="EAN8">EAN-8</option>
                    <option value="UPC">UPC-A</option>
                    <option value="ITF14">ITF-14 (ç‰©æµ)</option>
                    <option value="MSI">MSI Plessey</option>
                    <option value="pharmacode">Pharmacode (è¯å“)</option>
                    <option value="codabar">Codabar (åº“å¾·å·´ç )</option>
                    <option value="I2OF5">Interleaved 2 of 5</option>
                </select>
                <button class="primary-btn" onclick="generateBarcodes()" id="generateBtn">ç”Ÿæˆæ¡å½¢ç </button>
                <button class="primary-btn" onclick="exportSVGs()" id="exportBtn">å¯¼å‡ºZIP</button>
                <button class="secondary-btn" onclick="processBarcodes('trim')">âœ‚ï¸ å»ç©ºç™½</button>
                <button class="secondary-btn" onclick="processBarcodes('trimLast')">â†µ å»æœ«ä½</button>
                
            </div>
            <div id="statusBar" class="status-bar"></div>
        </div>

        <div class="preview-grid" id="previewArea"></div>
    </div>

    <script>
        let isLibsLoaded = false;

        function copyInputContent() {
            const input = document.getElementById('inputArea');
            navigator.clipboard.writeText(input.value).then(() => {
                showCopyNotice('âœ… å·²å¤åˆ¶');
            }).catch(() => {
                showCopyNotice('âŒ å¤åˆ¶å¤±è´¥');
            });
        }

        function showCopyNotice(message) {
            const btn = document.querySelector('.copy-input-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = message;
            btn.style.opacity = 0.9;

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.opacity = 1;
            }, 1500);
        }

        function processBarcodes(type) {
            const input = document.getElementById('inputArea');
            let codes = input.value.split('\n');

            codes = codes.map(code => {
                let processed = code.trimEnd();
                if (type === 'trimLast') {
                    processed = processed.slice(0, -1).trimEnd();
                }
                return processed;
            }).filter(code => code); // è¿‡æ»¤ç©ºè¡Œ

            input.value = codes.join('\n');
            updateStatus(`âœ… å·²æ‰§è¡Œ ${type === 'trim' ? 'å»ç©ºç™½' : 'å»æœ«ä½'} æ“ä½œ`);
        }

        function checkDependencies() {
            return !!window.JsBarcode && !!window.JSZip && !!window.saveAs;
        }

        function updateStatus(message, type = 'info') {
            const statusBar = document.getElementById('statusBar');
            statusBar.className = `status-bar ${type}`;
            statusBar.innerHTML = message;

            if (type === 'error') {
                console.error(message);
            } else if (type === 'success') {
                console.log(message);
            }
        }

        window.generateBarcodes = function () {
            if (!checkDependencies()) {
                updateStatus('âŒ å¿…éœ€åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                return;
            }

            const input = document.getElementById('inputArea').value.trim();
            const format = document.getElementById('formatSelect').value;
            const preview = document.getElementById('previewArea');

            if (!input) {
                updateStatus('âš ï¸ è¯·è¾“å…¥æ¡å½¢ç å†…å®¹', 'error');
                return;
            }

            preview.innerHTML = '';
            const codes = input.split('\n').filter(c => c.trim());

            codes.forEach((content, index) => {
                const card = document.createElement('div');
                card.className = 'barcode-card';

                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 300 150');
                svg.style.maxWidth = '100%';
                svg.style.height = '120px';
                svg.dataset.content = content; // æ·»åŠ å†…å®¹å­˜å‚¨

                try {
                    JsBarcode(svg, content, {
                        format: format,
                        displayValue: true,
                        width: 2,
                        height: 80,
                        margin: 15,
                        fontOptions: 'bold',
                        fontSize: 14,
                        valid: (valid) => {
                            if (!valid) throw new Error('æ ¼å¼æ— æ•ˆ');
                        }
                    });
                } catch (e) {
                    svg.innerHTML = `
                        <text x="50%" y="50%"
                              dominant-baseline="middle"
                              text-anchor="middle"
                              fill="var(--error)"
                              font-size="12"
                              font-family="monospace">
                            ! ${e.message} !
                        </text>
                    `;
                }

                card.appendChild(svg);
                preview.appendChild(card);
            });

            updateStatus(`âœ… æˆåŠŸç”Ÿæˆ ${codes.length} ä¸ªæ¡å½¢ç `, 'success');
        };

        // æ·»åŠ æ–‡ä»¶åå¤„ç†å‡½æ•°
        function sanitizeFileName(name) {
            return name
                .trim()
                .replace(/\s+/g, '_')
                .replace(/[^\w-]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_+/, '')
                .replace(/_+$/, '')
                .substring(0, 50)
                || 'barcode';
        }

        window.exportSVGs = async function () {
            if (!checkDependencies()) {
                updateStatus('âŒ å¿…éœ€åº“æœªåŠ è½½', 'error');
                return;
            }

            const svgs = document.querySelectorAll('svg');
            if (svgs.length === 0) {
                updateStatus('âš ï¸ è¯·å…ˆç”Ÿæˆæ¡å½¢ç ', 'error');
                return;
            }

            try {
                updateStatus('â³ æ­£åœ¨æ‰“åŒ…æ–‡ä»¶...', 'info loading');

                const zip = new JSZip();
                const usedNames = new Map();

                Array.from(svgs).forEach((svg, index) => {
                    // ä» SVG å…ƒç´ è·å–åŸå§‹å†…å®¹
                    const originalContent = svg.dataset.content || `barcode_${index + 1}`;
                    const baseName = sanitizeFileName(originalContent);
                    let finalName = baseName;

                    // å¤„ç†é‡å¤æ–‡ä»¶å
                    if (usedNames.has(baseName)) {
                        const count = usedNames.get(baseName) + 1;
                        usedNames.set(baseName, count);
                        finalName = `${baseName}_${count}`;
                    } else {
                        usedNames.set(baseName, 1);
                    }

                    // ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶å
                    const fileName = `${finalName}.svg`;
                    const svgString = new XMLSerializer().serializeToString(svg);
                    zip.file(fileName, svgString);
                });

                const content = await zip.generateAsync({ type: 'blob' });
                saveAs(content, `barcodes_${Date.now()}.zip`);
                updateStatus('âœ… å¯¼å‡ºå®Œæˆï¼Œå¼€å§‹ä¸‹è½½', 'success');
            } catch (e) {
                updateStatus(`âŒ å¯¼å‡ºå¤±è´¥: ${e.message}`, 'error');
            }
        };

        window.addEventListener('load', () => {
            if (!checkDependencies()) {
                updateStatus('âš ï¸ æ­£åœ¨åŠ è½½å¿…éœ€åº“...', 'info loading');
                document.getElementById('generateBtn').disabled = true;
                document.getElementById('exportBtn').disabled = true;

                setTimeout(() => {
                    if (!checkDependencies()) {
                        updateStatus('âŒ æ— æ³•åŠ è½½å¿…éœ€åº“ï¼Œè¯·<a href="#local-setup">ä½¿ç”¨æœ¬åœ°æ–‡ä»¶</a>', 'error');
                    } else {
                        document.getElementById('generateBtn').disabled = false;
                        document.getElementById('exportBtn').disabled = false;
                        updateStatus('âœ”ï¸ æ‰€æœ‰åº“å·²åŠ è½½å®Œæˆ', 'success');
                    }
                }, 5000);
            }
        });
    </script>
</body>

</html>